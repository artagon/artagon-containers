# Production Images Specification

## ADDED Requirements

### Requirement: Multi-Architecture Support

Production images SHALL be built for both linux/amd64 and linux/arm64 architectures to support diverse cloud infrastructure.

#### Scenario: Production image is multi-architecture

- **WHEN** production image manifest is inspected
- **THEN** manifest SHALL be a manifest list containing linux/amd64 and linux/arm64 entries
- **AND** both architecture images SHALL be built and pushed to registry

#### Scenario: Docker automatically selects correct architecture

- **WHEN** user pulls production image on amd64 host
- **THEN** Docker SHALL automatically select and pull linux/amd64 variant
- **AND** user does not need to specify architecture explicitly

#### Scenario: Kubernetes supports multi-arch deployments

- **WHEN** Kubernetes deployment references production image
- **THEN** nodes SHALL pull correct architecture variant based on node platform
- **AND** mixed-architecture clusters SHALL schedule pods appropriately

### Requirement: Immutable Production Tags

Production images SHALL use immutable tags that are never overwritten to ensure deployment reproducibility and audit trails.

#### Scenario: Production tags are stable

- **WHEN** production image is tagged (e.g., `chainguard-jdk25`)
- **THEN** tag SHALL NOT be overwritten by subsequent builds
- **AND** tag SHALL reference same image digest permanently

#### Scenario: Production tags lack ci- prefix

- **WHEN** production image tag is inspected
- **THEN** tag SHALL NOT contain `ci-` prefix
- **AND** tag SHALL follow production naming convention `<base>-<flavor>`

#### Scenario: Production image includes production label

- **WHEN** production image OCI metadata is inspected
- **THEN** label `org.opencontainers.image.ci` SHALL NOT exist or SHALL equal "false"
- **AND** label `org.opencontainers.image.description` SHALL describe production use case

### Requirement: Cosign Cryptographic Signing

Production images SHALL be signed with Cosign using keyless signing to provide authenticity and integrity guarantees.

#### Scenario: Production image is signed

- **WHEN** user runs `cosign verify <production-image>`
- **THEN** verification SHALL succeed with valid signature
- **AND** signature SHALL reference GitHub Actions OIDC identity
- **AND** signature SHALL be recorded in Rekor transparency log

#### Scenario: Signing workflow uses keyless mode

- **WHEN** production build workflow signs image
- **THEN** workflow SHALL set `COSIGN_EXPERIMENTAL=1`
- **AND** workflow SHALL use GitHub Actions OIDC token for identity
- **AND** signature SHALL include builder identity and commit metadata

#### Scenario: Signing adds minimal build time

- **WHEN** production build includes signing step
- **THEN** signing SHALL complete within 60 seconds
- **AND** build time overhead is acceptable for production quality

### Requirement: SBOM Generation and Attestation

Production images SHALL include CycloneDX SBOM (Software Bill of Materials) generated by Syft and attested via Cosign.

#### Scenario: SBOM generated for production image

- **WHEN** production build workflow generates SBOM
- **THEN** workflow SHALL invoke Syft with CycloneDX JSON output format
- **AND** SBOM SHALL enumerate all packages, libraries, and dependencies
- **AND** SBOM SHALL be stored as build artifact

#### Scenario: SBOM attached as attestation

- **WHEN** production build attests SBOM
- **THEN** workflow SHALL invoke `cosign attest --type cyclonedx`
- **AND** attestation SHALL be signed and uploaded to registry
- **AND** attestation SHALL be retrievable via `cosign download attestation`

#### Scenario: SBOM verification succeeds

- **WHEN** user runs `cosign verify-attestation --type cyclonedx <production-image>`
- **THEN** verification SHALL succeed
- **AND** SBOM content SHALL be displayed
- **AND** SBOM SHALL include accurate component inventory

### Requirement: Comprehensive Vulnerability Scanning

Production images SHALL be scanned with both Trivy and Grype, failing builds on HIGH or CRITICAL severity CVEs.

#### Scenario: Production scan fails on HIGH CVE

- **WHEN** Trivy or Grype detects HIGH severity CVE in production image
- **THEN** production build SHALL exit with non-zero status
- **AND** image SHALL NOT be pushed to registry
- **AND** CVE details SHALL be logged and tracked

#### Scenario: Production scan fails on CRITICAL CVE

- **WHEN** Trivy or Grype detects CRITICAL severity CVE
- **THEN** production build SHALL exit immediately with non-zero status
- **AND** automated issue SHALL be created in repository
- **AND** security team SHALL be notified

#### Scenario: Production uses dual scanners

- **WHEN** production workflow scans image
- **THEN** workflow SHALL invoke both Trivy and Grype
- **AND** workflow SHALL fail if either scanner detects HIGH/CRITICAL CVEs
- **AND** both scan results SHALL be logged for comparison

### Requirement: SLSA Provenance Attestation

Production images SHALL include SLSA Level 3 provenance attestations documenting build environment, inputs, and parameters.

#### Scenario: SLSA provenance generated

- **WHEN** production build completes
- **THEN** workflow SHALL generate SLSA provenance using `slsa-github-generator`
- **AND** provenance SHALL include builder identity, source repository, commit SHA, build parameters

#### Scenario: SLSA provenance verifiable

- **WHEN** user runs `cosign verify-attestation --type slsaprovenance <production-image>`
- **THEN** verification SHALL succeed
- **AND** provenance SHALL display GitHub Actions builder identity
- **AND** provenance SHALL reference correct source commit and workflow

#### Scenario: SLSA Level 3 compliance

- **WHEN** provenance is inspected for compliance
- **THEN** provenance SHALL meet SLSA Level 3 requirements (isolated build, signed provenance, hardened platform)
- **AND** provenance SHALL be suitable for regulatory compliance (HIPAA, SOC2, FedRAMP)

### Requirement: Main Branch Build Trigger

Production builds SHALL trigger automatically on pushes to main branch and on release tags to ensure tested code reaches registry.

#### Scenario: Production build triggers on main push

- **WHEN** commits are pushed to main branch
- **THEN** production workflow SHALL trigger automatically
- **AND** production workflow SHALL build all 15 image targets
- **AND** images SHALL be pushed to registry with signing and attestations

#### Scenario: Production build triggers on release tag

- **WHEN** release tag (e.g., `v1.0.0`) is created
- **THEN** release workflow SHALL trigger
- **AND** release workflow SHALL build, sign, and publish images
- **AND** release artifacts SHALL include SBOM bundle and verification instructions

#### Scenario: Production build does not trigger on PR

- **WHEN** pull request is created or updated
- **THEN** production workflow SHALL NOT trigger
- **AND** CI workflow SHALL handle PR builds independently

### Requirement: Registry Cache for Production Builds

Production builds SHALL use registry cache backend to ensure reproducible builds and support multi-runner scenarios.

#### Scenario: Production build uses registry cache

- **WHEN** production workflow builds image
- **THEN** workflow SHALL specify `--set *.cache-from=type=registry,ref=<cache-ref>` when using registry cache
- **AND** workflow SHALL specify `--set *.cache-to=type=registry,ref=<cache-ref>,mode=max` when using registry cache
- **AND** cache SHALL be stored in container registry for cross-runner access

#### Scenario: Registry cache supports reproducibility

- **WHEN** production build uses registry cache
- **THEN** builds SHALL be reproducible across different GitHub Actions runners
- **AND** cache SHALL NOT cause digest changes for identical source

### Requirement: Production-Only Dockerfile Configuration

Production images SHALL be built with `BUILD_TARGET=production` build arg to exclude debugging tools and maintain minimal attack surface.

#### Scenario: Production build excludes debugging tools

- **WHEN** production image is built with `BUILD_TARGET=production`
- **THEN** image SHALL NOT include debugging utilities (curl, netcat, bind-tools)
- **AND** image size SHALL be minimized

#### Scenario: Production Dockerfile validation

- **WHEN** production image is inspected for package inventory
- **THEN** only necessary JDK and runtime packages SHALL be present
- **AND** development tools SHALL be absent
- **AND** package list SHALL match security hardening guidelines

### Requirement: Build Time Metrics and Reporting

Production builds SHALL report build time metrics, image sizes, and vulnerability scan results in workflow summary.

#### Scenario: Production build reports metrics

- **WHEN** production workflow completes
- **THEN** workflow SHALL append metrics to GitHub Actions job summary
- **AND** metrics SHALL include: build time, image size, layer count, CVE count
- **AND** summary SHALL be viewable in GitHub Actions UI

#### Scenario: Metrics tracked over time

- **WHEN** multiple production builds complete
- **THEN** metrics SHALL enable trend analysis (build time regression, size growth)
- **AND** anomalies SHALL be detectable via summary comparison
