name: Build and Push

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io/${{ github.repository }}
  COSIGN_EXPERIMENTAL: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        include:
          - target: chainguard-jdk25-musl
          - target: chainguard-jdk25
          - target: chainguard-jdk26ea-musl
          - target: chainguard-jdk26ea
          - target: chainguard-jdk26valhalla-musl
          - target: chainguard-jdk26valhalla
          - target: distroless-jre25
          - target: distroless-jre25-musl
          - target: distroless-jre26ea
          - target: distroless-jre26ea-musl
          - target: distroless-jre26valhalla
          - target: distroless-jre26valhalla-musl
          - target: ubi9-jdk25
          - target: ubi9-jdk26ea
          - target: ubi9-jdk26valhalla
      fail-fast: false
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Install security tooling
        run: |
          curl --fail --location --proto '=https' --tlsv1.3 --retry 3 --retry-delay 2 --silent --show-error \
            https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl --fail --location --proto '=https' --tlsv1.3 --retry 3 --retry-delay 2 --silent --show-error \
            https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl --fail --location --proto '=https' --tlsv1.3 --retry 3 --retry-delay 2 --silent --show-error \
            https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Install AppArmor tooling
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/azure-cli.list || true
          sudo apt-get update
          sudo apt-get install -y apparmor-utils

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          docker buildx bake ${{ matrix.target }} \
            --set *.args.SOURCE_DATE_EPOCH=$(date +%s) \
            --set *.cache-from=type=gha \
            --set *.cache-to=type=gha,mode=max \
            --push

      - name: Validate hardening
        run: ./scripts/validate_hardening.sh $REGISTRY:${{ matrix.target }}

      - name: Prepare attestation workspace
        run: mkdir -p attestations sbom

      - name: Attest JDK resolution
        run: |
          IMAGE_REF="${REGISTRY}:${{ matrix.target }}"
          ./scripts/attest_jdk_resolution.sh ${{ matrix.target }} attestations/jdk-resolution-${{ matrix.target }}.json
          cosign attest --yes \
            --predicate attestations/jdk-resolution-${{ matrix.target }}.json \
            --type https://artagon.dev/attestations/jdk-resolution/v1 \
            ${IMAGE_REF}

      - name: Generate SBOM
        run: |
          IMAGE_REF="${REGISTRY}:${{ matrix.target }}"
          syft ${IMAGE_REF} -o cyclonedx-json > sbom/${{ matrix.target }}.cdx.json

      - name: Attest SBOM metadata
        run: |
          IMAGE_REF="${REGISTRY}:${{ matrix.target }}"
          SBOM_FILE="sbom/${{ matrix.target }}.cdx.json"
          SBOM_SHA="$(sha256sum "${SBOM_FILE}" | awk '{print $1}')"
          SYFT_VERSION="$(syft version | head -n 1 | sed 's/^Version: //')"
          GENERATED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          jq -n \
            --arg target "${{ matrix.target }}" \
            --arg format "cyclonedx-json" \
            --arg syft_version "${SYFT_VERSION}" \
            --arg sbom_sha256 "${SBOM_SHA}" \
            --arg generated_at "${GENERATED_AT}" \
            '{target: $target, format: $format, syft_version: $syft_version, sbom_sha256: $sbom_sha256, generated_at: $generated_at}' \
            > attestations/sbom-metadata-${{ matrix.target }}.json
          cosign attest --yes \
            --predicate attestations/sbom-metadata-${{ matrix.target }}.json \
            --type https://artagon.dev/attestations/sbom-metadata/v1 \
            ${IMAGE_REF}

      - name: Upload SBOM
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: sbom-${{ matrix.target }}
          path: sbom/${{ matrix.target }}.cdx.json

      - name: Scan (Trivy)
        id: trivy
        run: |
          IMAGE_REF="${REGISTRY}:${{ matrix.target }}"
          set +e
          trivy image --exit-code 1 --severity HIGH,CRITICAL \
            --format json --output attestations/trivy-${{ matrix.target }}.json \
            ${IMAGE_REF}
          echo "trivy_exit=$?" >> "$GITHUB_OUTPUT"
          set -e

      - name: Scan (Grype)
        id: grype
        run: |
          IMAGE_REF="${REGISTRY}:${{ matrix.target }}"
          set +e
          grype ${IMAGE_REF} -o json --fail-on high > attestations/grype-${{ matrix.target }}.json
          echo "grype_exit=$?" >> "$GITHUB_OUTPUT"
          set -e

      - name: Attest vulnerability scan metadata
        env:
          TARGET: ${{ matrix.target }}
          TRIVY_EXIT: ${{ steps.trivy.outputs.trivy_exit }}
          GRYPE_EXIT: ${{ steps.grype.outputs.grype_exit }}
        run: |
          export TRIVY_VERSION="$(trivy --version | head -n 1 | sed 's/^Version: //')"
          export GRYPE_VERSION="$(grype version | head -n 1 | sed 's/^Version: //')"
          export TRIVY_PATH="attestations/trivy-${TARGET}.json"
          export GRYPE_PATH="attestations/grype-${TARGET}.json"
          export OUTPUT_PATH="attestations/scan-${TARGET}.json"
          python3 ./scripts/scan_attest.py
          IMAGE_REF="${REGISTRY}:${TARGET}"
          cosign attest --yes \
            --predicate attestations/scan-${{ matrix.target }}.json \
            --type https://artagon.dev/attestations/vulnerability-scan/v1 \
            ${IMAGE_REF}

      - name: Upload attestation artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: attestations-${{ matrix.target }}
          path: attestations/*${{ matrix.target }}*.json

      - name: Sign image
        run: cosign sign --yes $REGISTRY:${{ matrix.target }}

      - name: Attest SBOM
        run: cosign attest --yes --predicate sbom/${{ matrix.target }}.cdx.json --type cyclonedx $REGISTRY:${{ matrix.target }}

      - name: Enforce scan gates
        run: |
          if [[ "${{ steps.trivy.outputs.trivy_exit }}" != "0" ]]; then
            echo "Trivy scan failed" >&2
            exit 1
          fi
          if [[ "${{ steps.grype.outputs.grype_exit }}" != "0" ]]; then
            echo "Grype scan failed" >&2
            exit 1
          fi

  digests:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      digest_map: ${{ steps.digests.outputs.map }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve image digests
        id: digests
        run: |
          MAP=$(python3 ./scripts/resolve_digests.py)
          echo "map=$MAP" >> "$GITHUB_OUTPUT"
        env:
          TAGS: "chainguard-jdk25-musl chainguard-jdk25 chainguard-jdk26ea-musl chainguard-jdk26ea chainguard-jdk26valhalla-musl chainguard-jdk26valhalla distroless-jre25 distroless-jre25-musl distroless-jre26ea distroless-jre26ea-musl distroless-jre26valhalla distroless-jre26valhalla-musl ubi9-jdk25 ubi9-jdk26ea ubi9-jdk26valhalla"
          IMAGE: ${{ env.REGISTRY }}

  provenance:
    needs: digests
    permissions:
      actions: read
      id-token: write
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        target:
          - chainguard-jdk25-musl
          - chainguard-jdk25
          - chainguard-jdk26ea-musl
          - chainguard-jdk26ea
          - chainguard-jdk26valhalla-musl
          - chainguard-jdk26valhalla
          - distroless-jre25
          - distroless-jre25-musl
          - distroless-jre26ea
          - distroless-jre26ea-musl
          - distroless-jre26valhalla
          - distroless-jre26valhalla-musl
          - ubi9-jdk25
          - ubi9-jdk26ea
          - ubi9-jdk26valhalla
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ghcr.io/${{ github.repository }}
      digest: ${{ fromJSON(needs.digests.outputs.digest_map)[matrix.target] }}
    secrets:
      registry-username: ${{ github.actor }}
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  verify:
    needs: provenance
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        target:
          - chainguard-jdk25-musl
          - chainguard-jdk25
          - chainguard-jdk26ea-musl
          - chainguard-jdk26ea
          - chainguard-jdk26valhalla-musl
          - chainguard-jdk26valhalla
          - distroless-jre25
          - distroless-jre25-musl
          - distroless-jre26ea
          - distroless-jre26ea-musl
          - distroless-jre26valhalla
          - distroless-jre26valhalla-musl
          - ubi9-jdk25
          - ubi9-jdk26ea
          - ubi9-jdk26valhalla
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Verify supply-chain attestations
        run: ./scripts/verify_supply_chain.sh $REGISTRY:${{ matrix.target }}

  summary:
    needs: [build, provenance, verify]
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## Build Matrix Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All 15 container image variants built and scanned successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
